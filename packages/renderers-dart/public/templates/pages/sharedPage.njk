{% extends "layout.njk" %}
{% import "macros.njk" as macros %}

{% block main %}
// Shared utilities and types for the SDK.

import 'dart:convert';
import 'dart:typed_data';

import 'package:solana/solana.dart';

/// Account not found error.
class AccountNotFoundError extends Error {
  /// The address of the account that was not found.
  final Ed25519HDPublicKey address;

  /// Creates a new AccountNotFoundError.
  AccountNotFoundError(this.address);

  @override
  String toString() => 'Account not found: $address';
}

/// Binary reader for decoding Borsh-encoded data.
class BinaryReader {
  final ByteData _data;
  int _offset = 0;

  /// Creates a new BinaryReader.
  BinaryReader(this._data);

  /// Reads a boolean value.
  bool readBool() {
    final value = _data.getUint8(_offset) != 0;
    _offset += 1;
    return value;
  }

  /// Reads an unsigned 8-bit integer.
  int readU8() {
    final value = _data.getUint8(_offset);
    _offset += 1;
    return value;
  }

  /// Reads an unsigned 16-bit integer.
  int readU16() {
    final value = _data.getUint16(_offset, Endian.little);
    _offset += 2;
    return value;
  }

  /// Reads an unsigned 32-bit integer.
  int readU32() {
    final value = _data.getUint32(_offset, Endian.little);
    _offset += 4;
    return value;
  }

  /// Reads an unsigned 64-bit integer.
  BigInt readU64() {
    final low = _data.getUint32(_offset, Endian.little);
    final high = _data.getUint32(_offset + 4, Endian.little);
    _offset += 8;
    return (BigInt.from(high) << 32) | BigInt.from(low);
  }

  /// Reads a signed 8-bit integer.
  int readI8() {
    final value = _data.getInt8(_offset);
    _offset += 1;
    return value;
  }

  /// Reads a signed 16-bit integer.
  int readI16() {
    final value = _data.getInt16(_offset, Endian.little);
    _offset += 2;
    return value;
  }

  /// Reads a signed 32-bit integer.
  int readI32() {
    final value = _data.getInt32(_offset, Endian.little);
    _offset += 4;
    return value;
  }

  /// Reads a signed 64-bit integer.
  BigInt readI64() {
    final low = _data.getUint32(_offset, Endian.little);
    final high = _data.getInt32(_offset + 4, Endian.little);
    _offset += 8;
    return (BigInt.from(high) << 32) | BigInt.from(low);
  }

  /// Reads a string.
  String readString() {
    final length = readU32();
    final bytes = Uint8List.view(_data.buffer, _data.offsetInBytes + _offset, length);
    _offset += length;
    return utf8.decode(bytes);
  }

  /// Reads a fixed-size array of bytes.
  Uint8List readFixedArray(int length) {
    final bytes = Uint8List.view(_data.buffer, _data.offsetInBytes + _offset, length);
    _offset += length;
    return bytes;
  }

  /// Reads a variable-length array of bytes.
  Uint8List readBytes() {
    final length = readU32();
    return readFixedArray(length);
  }
}

/// Binary writer for encoding Borsh data.
class BinaryWriter {
  final List<int> _bytes = [];

  /// Writes a boolean value.
  void writeBool(bool value) {
    _bytes.add(value ? 1 : 0);
  }

  /// Writes an unsigned 8-bit integer.
  void writeU8(int value) {
    _bytes.add(value & 0xFF);
  }

  /// Writes an unsigned 16-bit integer.
  void writeU16(int value) {
    _bytes.addAll([
      value & 0xFF,
      (value >> 8) & 0xFF,
    ]);
  }

  /// Writes an unsigned 32-bit integer.
  void writeU32(int value) {
    _bytes.addAll([
      value & 0xFF,
      (value >> 8) & 0xFF,
      (value >> 16) & 0xFF,
      (value >> 24) & 0xFF,
    ]);
  }

  /// Writes an unsigned 64-bit integer.
  void writeU64(BigInt value) {
    final low = value & BigInt.from(0xFFFFFFFF);
    final high = (value >> 32) & BigInt.from(0xFFFFFFFF);
    
    _bytes.addAll([
      low.toInt() & 0xFF,
      (low.toInt() >> 8) & 0xFF,
      (low.toInt() >> 16) & 0xFF,
      (low.toInt() >> 24) & 0xFF,
      high.toInt() & 0xFF,
      (high.toInt() >> 8) & 0xFF,
      (high.toInt() >> 16) & 0xFF,
      (high.toInt() >> 24) & 0xFF,
    ]);
  }

  /// Writes a signed 8-bit integer.
  void writeI8(int value) {
    writeU8(value & 0xFF);
  }

  /// Writes a signed 16-bit integer.
  void writeI16(int value) {
    writeU16(value & 0xFFFF);
  }

  /// Writes a signed 32-bit integer.
  void writeI32(int value) {
    writeU32(value & 0xFFFFFFFF);
  }

  /// Writes a signed 64-bit integer.
  void writeI64(BigInt value) {
    writeU64(value & (BigInt.one << 64) - BigInt.one);
  }

  /// Writes a string.
  void writeString(String value) {
    final bytes = utf8.encode(value);
    writeU32(bytes.length);
    _bytes.addAll(bytes);
  }

  /// Writes a fixed-size array of bytes.
  void writeFixedArray(Uint8List value) {
    _bytes.addAll(value);
  }

  /// Writes a variable-length array of bytes.
  void writeBytes(Uint8List value) {
    writeU32(value.length);
    _bytes.addAll(value);
  }

  /// Returns the byte array.
  Uint8List toBytes() => Uint8List.fromList(_bytes);
}
{% endblock %}